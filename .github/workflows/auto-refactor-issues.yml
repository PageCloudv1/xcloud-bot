name: 'ğŸ”„ Auto-Refactor Issues by rootkit-original'

on:
  issues:
    types: [opened]

concurrency:
  group: '${{ github.workflow }}-refactor-${{ github.event.issue.number }}'
  cancel-in-progress: true

defaults:
  run:
    shell: 'bash'

jobs:
  auto-refactor:
    name: 'ğŸ”„ Refatorar e Auto-Assinar Issue'
    runs-on: 'ubuntu-latest'
    timeout-minutes: 10

    # SÃ³ executa se o autor da issue for rootkit-original
    if: github.event.issue.user.login == 'rootkit-original'

    permissions:
      contents: 'read'
      issues: 'write'
      pull-requests: 'read'

    steps:
      - name: 'Generate GitHub App Token'
        id: 'generate_token'
        uses: 'actions/create-github-app-token@v1'
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_PRIVATE_KEY }}
          owner: 'PageCloudv1'
          repositories: 'xcloud-bot'

      - name: 'ğŸ” Analisar Issue com Gemini para RefatoraÃ§Ã£o'
        id: 'gemini_refactor'
        uses: 'google-github-actions/run-gemini-cli@v0'
        with:
          gemini_api_key: '${{ secrets.GEMINI_API_KEY }}'
          prompt: |-
            VocÃª Ã© um especialista em refatoraÃ§Ã£o de issues do GitHub. Sua tarefa Ã© analisar a issue criada por rootkit-original e sugerir melhorias para tornÃ¡-la mais clara, completa e acionÃ¡vel.

            ## Issue Atual
            **TÃ­tulo**: ${{ github.event.issue.title }}
            **DescriÃ§Ã£o**: ${{ github.event.issue.body }}
            **NÃºmero**: #${{ github.event.issue.number }}
            **Autor**: ${{ github.event.issue.user.login }}

            ## Sua MissÃ£o
            Analise a issue e retorne APENAS um objeto JSON com sugestÃµes de refatoraÃ§Ã£o:

            {
              "titulo_refatorado": "Novo tÃ­tulo mais claro e descritivo",
              "descricao_refatorada": "DescriÃ§Ã£o completa e bem estruturada com todos os detalhes necessÃ¡rios",
              "labels_sugeridas": ["label1", "label2", "label3"],
              "prioridade_sugerida": "high|medium|low",
              "categoria_sugerida": "api|ui|infrastructure|workflow|bot|documentation|security|performance",
              "acao_imediata": "DescriÃ§Ã£o do que deve ser feito imediatamente"
            }

            ## Regras de RefatoraÃ§Ã£o
            1. **TÃ­tulo**: Deve ser claro, especÃ­fico e comeÃ§ar com verbo de aÃ§Ã£o quando apropriado
            2. **DescriÃ§Ã£o**: Deve incluir contexto, passos para reproduzir (se bug), impacto esperado, e critÃ©rios de aceitaÃ§Ã£o
            3. **Labels**: Use labels existentes apropriadas
            4. **Prioridade**: Baseie-se no impacto e urgÃªncia
            5. **Categoria**: Classifique corretamente o tipo de trabalho

            Retorne APENAS o JSON, sem markdown ou explicaÃ§Ãµes adicionais.

      - name: 'ğŸ“ Processar SugestÃµes de RefatoraÃ§Ã£o'
        id: 'process_refactor'
        if: steps.gemini_refactor.conclusion == 'success'
        shell: 'bash'
        env:
          GEMINI_RESPONSE: '${{ steps.gemini_refactor.outputs.summary }}'
        run: |-
          echo "ğŸ“¥ Resposta do Gemini:"
          echo "${GEMINI_RESPONSE}"

          # Extrair JSON da resposta
          REFACTOR_JSON=$(echo "${GEMINI_RESPONSE}" | sed 's/```json//g' | sed 's/```//g' | jq -r '.' 2>/dev/null)

          if [ -z "$REFACTOR_JSON" ] || [ "$REFACTOR_JSON" == "null" ]; then
            echo "âŒ NÃ£o foi possÃ­vel processar a resposta de refatoraÃ§Ã£o"
            exit 1
          fi

          # Extrair valores do JSON
          TITULO=$(echo "$REFACTOR_JSON" | jq -r '.titulo_refatorado // empty')
          DESCRICAO=$(echo "$REFACTOR_JSON" | jq -r '.descricao_refatorada // empty')
          LABELS=$(echo "$REFACTOR_JSON" | jq -r '.labels_sugeridas | join(",") // empty')
          PRIORIDADE=$(echo "$REFACTOR_JSON" | jq -r '.prioridade_sugerida // "medium"')
          CATEGORIA=$(echo "$REFACTOR_JSON" | jq -r '.categoria_sugerida // empty')
          ACAO=$(echo "$REFACTOR_JSON" | jq -r '.acao_imediata // empty')

          # Salvar outputs
          echo "titulo_refatorado=$TITULO" >> "${GITHUB_OUTPUT}"
          echo "descricao_refatorada=$DESCRICAO" >> "${GITHUB_OUTPUT}"
          echo "labels_sugeridas=$LABELS" >> "${GITHUB_OUTPUT}"
          echo "prioridade_sugerida=$PRIORIDADE" >> "${GITHUB_OUTPUT}"
          echo "categoria_sugerida=$CATEGORIA" >> "${GITHUB_OUTPUT}"
          echo "acao_imediata=$ACAO" >> "${GITHUB_OUTPUT}"

          echo "âœ… SugestÃµes de refatoraÃ§Ã£o processadas com sucesso"

      - name: 'ğŸ”„ Aplicar RefatoraÃ§Ã£o da Issue'
        if: steps.process_refactor.conclusion == 'success'
        uses: 'actions/github-script@v7'
        env:
          TITULO: '${{ steps.process_refactor.outputs.titulo_refatorado }}'
          DESCRICAO: '${{ steps.process_refactor.outputs.descricao_refatorada }}'
          LABELS: '${{ steps.process_refactor.outputs.labels_sugeridas }}'
          PRIORIDADE: '${{ steps.process_refactor.outputs.prioridade_sugerida }}'
          CATEGORIA: '${{ steps.process_refactor.outputs.categoria_sugerida }}'
          ACAO: '${{ steps.process_refactor.outputs.acao_imediata }}'
        with:
          github-token: '${{ steps.generate_token.outputs.token }}'
          script: |-
            const titulo = process.env.TITULO;
            const descricao = process.env.DESCRICAO;
            const labelsStr = process.env.LABELS;
            const prioridade = process.env.PRIORIDADE;
            const categoria = process.env.CATEGORIA;
            const acao = process.env.ACAO;

            // Preparar labels
            const labels = [];
            if (labelsStr) {
              labels.push(...labelsStr.split(',').map(l => l.trim()).filter(l => l));
            }
            if (prioridade) {
              labels.push(`priority:${prioridade}`);
            }
            if (categoria) {
              labels.push(`category:${categoria}`);
            }

            // Atualizar tÃ­tulo se fornecido
            if (titulo && titulo !== '${{ github.event.issue.title }}') {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                title: titulo
              });
              core.info(`TÃ­tulo atualizado: ${titulo}`);
            }

            // Atualizar descriÃ§Ã£o se fornecida
            if (descricao && descricao !== '${{ github.event.issue.body }}') {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: descricao
              });
              core.info(`DescriÃ§Ã£o atualizada`);
            }

            // Aplicar labels
            if (labels.length > 0) {
              await github.rest.issues.setLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
              core.info(`Labels aplicadas: ${labels.join(', ')}`);
            }

            // Auto-assinar para rootkit-original
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              assignees: ['rootkit-original']
            });
            core.info('Issue auto-assinada para rootkit-original');

      - name: 'ğŸ’¬ Postar ComentÃ¡rio de ConfirmaÃ§Ã£o'
        if: steps.process_refactor.conclusion == 'success'
        uses: 'actions/github-script@v7'
        env:
          ACAO: '${{ steps.process_refactor.outputs.acao_imediata }}'
        with:
          github-token: '${{ steps.generate_token.outputs.token }}'
          script: |-
            const acao = process.env.ACAO;

            const comentario = `## ğŸ”„ Issue Refatorada Automaticamente

            ğŸ¤– **xCloud Bot** identificou e aplicou melhorias nesta issue criada por @rootkit-original:

            ### âœ… **AÃ§Ãµes Realizadas**
            - **Auto-assinatura**: Issue atribuÃ­da automaticamente para vocÃª
            - **Labels aplicadas**: Baseadas na anÃ¡lise de conteÃºdo
            - **TÃ­tulo otimizado**: Para melhor clareza e aÃ§Ã£o
            - **DescriÃ§Ã£o aprimorada**: Com contexto e detalhes necessÃ¡rios

            ### ğŸ¯ **PrÃ³ximo Passo Recomendado**
            ${acao || 'Analise as melhorias aplicadas e proceda com o desenvolvimento'}

            ---
            ğŸ”„ *RefatoraÃ§Ã£o automÃ¡tica aplicada | Issue pronta para desenvolvimento*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comentario
            });

      - name: 'âŒ Notificar Falha na RefatoraÃ§Ã£o'
        if: failure()
        uses: 'actions/github-script@v7'
        with:
          github-token: '${{ steps.generate_token.outputs.token }}'
          script: |-
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## âš ï¸ Falha na RefatoraÃ§Ã£o AutomÃ¡tica

              ğŸ¤– **xCloud Bot** encontrou um problema ao tentar refatorar esta issue automaticamente.

              ### ğŸ” **O que Aconteceu**
              Ocorreu um erro durante o processo de anÃ¡lise e refatoraÃ§Ã£o da issue.

              ### ğŸ“‹ **AÃ§Ãµes Manuais NecessÃ¡rias**
              - Verifique se a issue estÃ¡ bem descrita
              - Aplique labels apropriadas manualmente
              - Atribua a issue para si mesmo

              ---
              âš ï¸ *RefatoraÃ§Ã£o falhou | AÃ§Ã£o manual necessÃ¡ria*`
            });