name: ğŸ—ï¸ Build - ConstruÃ§Ã£o de Artefatos

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'package.json'
      - 'package-lock.json'
      - 'tsconfig.json'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version to use'
        required: false
        type: string
        default: '20'
      build-command:
        description: 'Build command to execute'
        required: false
        type: string
        default: 'npm run build'
    outputs:
      build-status:
        description: 'Status of the build'
        value: ${{ jobs.build.outputs.status }}
      artifact-size:
        description: 'Size of the build artifacts'
        value: ${{ jobs.build.outputs.artifact-size }}
      build-version:
        description: 'Version of the build'
        value: ${{ jobs.build.outputs.version }}

env:
  NODE_VERSION: ${{ inputs.node-version || '20' }}

jobs:
  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.build-status.outputs.status }}
      artifact-size: ${{ steps.artifact-info.outputs.size }}
      version: ${{ steps.version-info.outputs.version }}
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ·ï¸ Generate version info
        id: version-info
        run: |
          VERSION="${GITHUB_SHA:0:7}-$(date +%Y%m%d-%H%M%S)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"
      
      - name: ğŸ—ï¸ Build project
        run: ${{ inputs.build-command || 'npm run build' }}
      
      - name: ğŸ” Verify build output
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Build directory 'dist' not found"
            exit 1
          fi
          echo "âœ… Build output verified"
      
      - name: ğŸ“Š Artifact size analysis
        id: artifact-info
        run: |
          SIZE=$(du -sh dist/ | cut -f1)
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "Artifact size: $SIZE"
      
      - name: ğŸ—œï¸ Optimize artifacts (placeholder)
        run: |
          echo "ğŸ—œï¸ Optimizing artifacts..."
          echo "Compression and optimization would happen here"
      
      - name: ğŸ“š Generate documentation (if configured)
        run: |
          if [ -f "package.json" ] && grep -q '"docs:build"' package.json; then
            echo "ğŸ“š Generating documentation..."
            npm run docs:build || echo "âš ï¸ Documentation generation skipped"
          else
            echo "â„¹ï¸ No documentation build script found"
          fi
      
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            dist/
            package.json
            package-lock.json
          retention-days: 7
          compression-level: 9
      
      - name: ğŸ“‹ Build summary
        id: build-status
        run: |
          echo "status=success" >> $GITHUB_OUTPUT
          echo "### ğŸ—ï¸ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“¦ Version: ${{ steps.version-info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“Š Artifact size: ${{ steps.artifact-info.outputs.size }}" >> $GITHUB_STEP_SUMMARY

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ” Run npm audit
        run: |
          echo "ğŸ” Running security audit..."
          npm audit --audit-level=moderate || echo "âš ï¸ Security issues found"

  quality-validation:
    name: âœ… Quality Validation
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./artifacts
      
      - name: âœ… Validate build artifacts
        run: |
          echo "âœ… Validating build artifacts..."
          if [ -d "artifacts/dist" ]; then
            echo "âœ… Build artifacts are valid"
          else
            echo "âŒ Build artifacts validation failed"
            exit 1
          fi
      
      - name: ğŸ“Š Performance benchmarks (placeholder)
        run: |
          echo "ğŸ“Š Running performance benchmarks..."
          echo "Performance tests would run here"
