name: '🔧 Register xCloud Bot GitHub App'

on:
  workflow_dispatch:
    inputs:
      validate_only:
        description: 'Only validate existing configuration (do not create issue)'
        required: false
        default: false
        type: boolean

jobs:
  register-github-app:
    runs-on: 'ubuntu-latest'
    timeout-minutes: 10
    permissions:
      contents: 'write'
      issues: 'write'
      pull-requests: 'write'
      actions: 'write'
    
    steps:
      - name: '📥 Checkout repository'
        uses: 'actions/checkout@v4'
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: '⚙️ Setup Node.js'
        uses: 'actions/setup-node@v4'
        with:
          node-version: '20'

      - name: '📋 Validate GitHub App Configuration'
        id: validate
        run: |
          echo "Running validation script..."
          node scripts/validate-github-app.cjs || echo "validation_failed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: '📊 Display Validation Results'
        run: |
          if [ -f .env ]; then
            echo "✅ .env file exists"
          else
            echo "❌ .env file not found"
          fi
          
          echo ""
          echo "📋 Configuration files:"
          ls -la github-app-manifest.json app.yml GITHUB_APP_SETUP.md 2>/dev/null || echo "Some files missing"

      - name: '📝 Generate Registration Instructions'
        if: steps.validate.outputs.validation_failed == 'true' && inputs.validate_only != true
        uses: 'actions/github-script@v7'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Read the setup guide
            const setupGuide = fs.readFileSync('GITHUB_APP_SETUP.md', 'utf8');
            
            const body = `# 🤖 xCloud Bot Registration Required

Para usar o xCloud Bot, você precisa registrar uma GitHub App.

## 🚀 Método Rápido - Script Interativo

Execute o script de registro interativo:

\`\`\`bash
npm run register:github-app
\`\`\`

Este script irá guiá-lo através de todo o processo.

## 📝 Método Manual

Siga as instruções completas em [GITHUB_APP_SETUP.md](./GITHUB_APP_SETUP.md)

### Passos Rápidos:

1. **Criar GitHub App**: https://github.com/settings/apps/new
2. **Configurar Permissões**:
   - Actions: Read and write
   - Checks: Read and write
   - Contents: Read and write
   - Issues: Read and write
   - Pull requests: Read and write
   
3. **Configurar Eventos**:
   - Issues
   - Pull requests
   - Push
   - Check runs

4. **Salvar Credenciais**:
   - App ID
   - Private Key (baixar .pem)
   
5. **Configurar Secrets** em Settings > Secrets > Actions:
   \`\`\`
   GITHUB_APP_ID=<seu-app-id>
   GITHUB_PRIVATE_KEY=<conteúdo-do-pem>
   \`\`\`

6. **Instalar a App** nos repositórios

## 🔍 Validar Configuração

Após configurar, valide sua instalação:

\`\`\`bash
npm run validate:github-app
\`\`\`

## 📚 Recursos

- [Documentação Completa](./GITHUB_APP_SETUP.md)
- [Guia Detalhado](./GITHUB_BOT_SETUP_GUIDE.md)
- [README](./README.md)

---

**Status da Configuração Atual:**
- [ ] GitHub App criada
- [ ] Credenciais configuradas
- [ ] App instalada nos repositórios
- [ ] Configuração validada
`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'github-app-registration'
            });

            if (issues.data.length > 0) {
              console.log('Registration issue already exists. Updating...');
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body
              });
            } else {
              console.log('Creating new registration issue...');
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '🤖 xCloud Bot Registration Required',
                body: body,
                labels: ['xcloud-bot', 'setup', 'github-app-registration']
              });
            }

      - name: '✅ Summary'
        run: |
          echo "═══════════════════════════════════════════════════════"
          echo "  🤖 xCloud Bot Registration Helper"
          echo "═══════════════════════════════════════════════════════"
          echo ""
          echo "📋 Next Steps:"
          echo ""
          echo "1. 🔗 Registrar GitHub App:"
          echo "   https://github.com/settings/apps/new"
          echo ""
          echo "2. 📚 Seguir instruções detalhadas:"
          echo "   - GITHUB_APP_SETUP.md (guia completo)"
          echo "   - Ou executar: npm run register:github-app"
          echo ""
          echo "3. 🔐 Configurar secrets no repositório:"
          echo "   Settings > Secrets and variables > Actions"
          echo ""
          echo "4. 🔍 Validar configuração:"
          echo "   npm run validate:github-app"
          echo ""
          echo "═══════════════════════════════════════════════════════"