name: 'üîß Register xCloud Bot GitHub App'

on:
  workflow_dispatch:
    inputs:
      force_register:
        description: 'Force re-register the GitHub App'
        required: false
        default: false
        type: boolean

jobs:
  register-github-app:
    runs-on: 'ubuntu-latest'
    timeout-minutes: 10
    permissions:
      contents: 'write'
      issues: 'write'
      pull-requests: 'write'
      actions: 'write'
    
    steps:
      - name: 'Checkout repository'
        uses: 'actions/checkout@v4'
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 'Create Setup Instructions'
        run: |
          cat > GITHUB_APP_SETUP.md << 'EOF'
          # xCloud Bot - GitHub App Setup
          
          ## Registro da GitHub App
          
          Para que o xCloud Bot funcione corretamente, voc√™ precisa registrar uma GitHub App.
          
          ### M√©todo Manual (Recomendado)
          
          1. Acesse: https://github.com/settings/apps/new
          2. Use as configura√ß√µes do arquivo github-app-manifest.json
          3. Ap√≥s criar a app, configure as vari√°veis de ambiente
          
          ## Permiss√µes Necess√°rias
          
          - Actions (write)
          - Checks (write)
          - Contents (write)
          - Issues (write)
          - Pull Requests (write)
          - Repository Projects (write)
          
          ## Ap√≥s o Registro
          
          1. Instale a app em seus reposit√≥rios
          2. Configure as vari√°veis de ambiente no GitHub Secrets
          3. Execute o workflow xCloud Bot Setup nos reposit√≥rios alvo
          EOF

      - name: 'Update README'
        run: |
          if [ -f "README.md" ]; then
            if ! grep -q "Bot Status" README.md; then
              echo "" >> README.md
              echo "## Bot Status" >> README.md
              echo "" >> README.md
              echo "Para usar o xCloud Bot, registre uma GitHub App." >> README.md
              echo "Consulte GITHUB_APP_SETUP.md para instru√ß√µes." >> README.md
            fi
          fi

      - name: 'Commit Setup Files'
        run: |
          git config --local user.email "xcloud-bot@pagecloud.dev"
          git config --local user.name "xCloud Bot Setup"
          
          git add app.yml github-app-manifest.json GITHUB_APP_SETUP.md README.md
          
          if ! git diff --staged --quiet; then
            git commit -m "Add GitHub App registration files"
            git push
          fi

      - name: 'Create Registration Issue'
        uses: 'actions/github-script@v7'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = `# xCloud Bot Registration Required

Para usar o xCloud Bot, registre uma GitHub App.

## Como Registrar

1. Acesse: https://github.com/settings/apps/new
2. Cole o conte√∫do do arquivo github-app-manifest.json
3. Configure as permiss√µes necess√°rias

## Pr√≥ximos Passos

- Registrar GitHub App
- Configurar secrets
- Instalar nos reposit√≥rios
- Testar funcionalidade

Consulte GITHUB_APP_SETUP.md para instru√ß√µes detalhadas.`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'xCloud Bot - GitHub App Registration Required',
              body: body,
              labels: ['xcloud-bot', 'setup', 'github-app']
            });

      - name: 'Summary'
        run: |
          echo "Setup do xCloud Bot preparado!"
          echo ""
          echo "Pr√≥ximos passos:"
          echo "1. Registrar GitHub App: https://github.com/settings/apps/new"
          echo "2. Configurar secrets no reposit√≥rio"
          echo "3. Instalar a app nos reposit√≥rios alvo"