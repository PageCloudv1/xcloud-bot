name: ðŸš€ Deploy

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: string
      artifact-name:
        description: 'Build artifact to deploy'
        required: false
        default: 'build-artifacts'
        type: string
      deploy-command:
        description: 'Deploy command to run'
        required: false
        default: 'npm run deploy'
        type: string
    outputs:
      deployment-url:
        description: "Deployment URL"
        value: ${{ jobs.deploy.outputs.url }}
      deployment-status:
        description: "Deployment status"
        value: ${{ jobs.deploy.outputs.status }}
        
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
        - staging
        - production
      skip-tests:
        description: 'Skip tests before deploy'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  DEPLOY_ENV: ${{ inputs.environment }}
  
jobs:
  pre-deploy:
    name: ðŸ” Pre-Deploy Checks
    runs-on: ubuntu-latest
    
    outputs:
      can-deploy: ${{ steps.checks.outputs.can-deploy }}
      
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ” Environment validation
      id: checks
      run: |
        case "${{ env.DEPLOY_ENV }}" in
          "staging"|"production")
            echo "âœ… Valid environment: ${{ env.DEPLOY_ENV }}"
            echo "can-deploy=true" >> $GITHUB_OUTPUT
            ;;
          *)
            echo "âŒ Invalid environment: ${{ env.DEPLOY_ENV }}"
            echo "can-deploy=false" >> $GITHUB_OUTPUT
            exit 1
            ;;
        esac
        
    - name: ðŸ›¡ï¸ Security checks
      run: |
        echo "ðŸ” Running security checks..."
        if npm audit --audit-level=high; then
          echo "âœ… No high-severity security issues found"
        else
          echo "âš ï¸ Security issues detected - review required"
        fi
        
  deploy:
    name: ðŸš€ Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: pre-deploy
    if: needs.pre-deploy.outputs.can-deploy == 'true'
    
    outputs:
      url: ${{ steps.deploy-info.outputs.url }}
      status: ${{ steps.deploy-status.outputs.status }}
      
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies
      run: npm ci
      
    - name: ðŸ“¥ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.artifact-name || 'build-artifacts' }}
        path: ./artifacts/
        
    - name: ðŸ“ Prepare deployment files
      run: |
        if [ -d "./artifacts/dist" ]; then
          cp -r ./artifacts/dist/* ./dist/ || mkdir -p ./dist && cp -r ./artifacts/dist/* ./dist/
        elif [ -d "./artifacts/build" ]; then
          cp -r ./artifacts/build/* ./build/ || mkdir -p ./build && cp -r ./artifacts/build/* ./build/
        else
          echo "âš ï¸ No build artifacts found, running build..."
          npm run build
        fi
        
    - name: ðŸ”§ Configure deployment
      run: |
        echo "ðŸ”§ Configuring deployment for ${{ env.DEPLOY_ENV }}"
        case "${{ env.DEPLOY_ENV }}" in
          "staging")
            echo "DEPLOY_URL=https://staging.xcloud-bot.example.com" >> $GITHUB_ENV
            echo "DEPLOY_BUCKET=staging-bucket" >> $GITHUB_ENV
            ;;
          "production")
            echo "DEPLOY_URL=https://xcloud-bot.example.com" >> $GITHUB_ENV
            echo "DEPLOY_BUCKET=production-bucket" >> $GITHUB_ENV
            ;;
        esac
        
    - name: ðŸš€ Deploy application
      run: |
        echo "ðŸš€ Deploying to ${{ env.DEPLOY_ENV }}..."
        
        # Simulate deployment process
        echo "ðŸ“¤ Uploading files..."
        sleep 2
        
        # Example deployment commands (replace with actual deployment logic)
        case "${{ env.DEPLOY_ENV }}" in
          "staging")
            echo "ðŸŒ± Deploying to staging environment..."
            # aws s3 sync dist/ s3://$DEPLOY_BUCKET/ --delete
            # aws cloudfront create-invalidation --distribution-id $STAGING_DISTRIBUTION_ID --paths "/*"
            ;;
          "production")
            echo "ðŸ­ Deploying to production environment..."
            # aws s3 sync dist/ s3://$DEPLOY_BUCKET/ --delete
            # aws cloudfront create-invalidation --distribution-id $PRODUCTION_DISTRIBUTION_ID --paths "/*"
            ;;
        esac
        
        echo "âœ… Deployment completed successfully"
        
    - name: ðŸ” Post-deploy verification
      run: |
        echo "ðŸ” Verifying deployment..."
        
        # Health check simulation
        sleep 3
        
        # You can add actual health checks here
        # curl -f $DEPLOY_URL/health || exit 1
        
        echo "âœ… Deployment verification successful"
        
    - name: ðŸ“Š Deployment info
      id: deploy-info
      run: |
        echo "url=${{ env.DEPLOY_URL }}" >> $GITHUB_OUTPUT
        echo "ðŸŽ‰ Deployment completed!"
        echo "ðŸ“ URL: ${{ env.DEPLOY_URL }}"
        
    - name: ðŸ“Š Deployment status
      id: deploy-status
      run: |
        echo "status=success" >> $GITHUB_OUTPUT
        
  smoke-tests:
    name: ðŸ’¨ Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies
      run: npm ci
      
    - name: ðŸ’¨ Run smoke tests
      run: |
        echo "ðŸ’¨ Running smoke tests against ${{ needs.deploy.outputs.url }}..."
        
        # Basic connectivity test
        if curl -f "${{ needs.deploy.outputs.url }}" > /dev/null 2>&1; then
          echo "âœ… Application is responding"
        else
          echo "âŒ Application not responding"
          exit 1
        fi
        
        # Run actual smoke tests if available
        if npm run test:smoke; then
          echo "âœ… Smoke tests passed"
        else
          echo "âš ï¸ No smoke tests found"
        fi
        
  notify:
    name: ðŸ“¢ Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy, smoke-tests]
    if: always()
    
    steps:
    - name: ðŸ“¢ Send deployment notification
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ] && [ "${{ needs.smoke-tests.result }}" == "success" ]; then
          echo "## âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **Environment:** ${{ env.DEPLOY_ENV }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **URL:** ${{ needs.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "â° **Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘¤ **Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **Environment:** ${{ env.DEPLOY_ENV }}" >> $GITHUB_STEP_SUMMARY
          echo "âŒ **Deploy Status:** ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "âŒ **Smoke Tests:** ${{ needs.smoke-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "â° **Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        fi
        
  rollback:
    name: ðŸ”„ Rollback
    runs-on: ubuntu-latest
    needs: [deploy, smoke-tests]
    if: failure() && github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ”„ Prepare rollback
      run: |
        echo "ðŸ”„ Deployment failed, preparing rollback..."
        echo "This would trigger rollback procedures"
        
    - name: ðŸ”„ Execute rollback
      run: |
        echo "ðŸ”„ Executing rollback to previous version..."
        # Add rollback logic here
        # This could involve:
        # - Reverting to previous deployment
        # - Restoring database if needed
        # - Updating DNS records
        
    - name: ðŸ“¢ Rollback notification
      run: |
        echo "## ðŸ”„ Rollback Executed" >> $GITHUB_STEP_SUMMARY
        echo "âŒ **Failed Deployment:** ${{ env.DEPLOY_ENV }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”„ **Rollback Status:** Completed" >> $GITHUB_STEP_SUMMARY
        echo "â° **Time:** $(date)" >> $GITHUB_STEP_SUMMARY