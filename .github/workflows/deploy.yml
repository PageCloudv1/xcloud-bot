name: ğŸš€ Deploy - Advanced Environment Management

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
        - development
        - staging
        - production
        default: 'staging'
      deployment_strategy:
        description: 'Deployment strategy'
        required: true
        type: choice
        options:
        - rolling
        - blue-green
        - canary
        default: 'rolling'
      force_deploy:
        description: 'Force deployment (skip health checks)'
        required: false
        type: boolean
        default: false

  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: string
      deployment_strategy:
        description: 'Deployment strategy'
        required: false
        type: string
        default: 'rolling'
    outputs:
      deployment-url:
        description: "Deployment URL"
        value: ${{ jobs.deploy.outputs.url }}
      deployment-version:
        description: "Deployed version"
        value: ${{ jobs.deploy.outputs.version }}

env:
  NODE_VERSION: '20'
  DEPLOY_ENV: ${{ inputs.environment }}
  DEPLOYMENT_STRATEGY: ${{ inputs.deployment_strategy || 'rolling' }}

jobs:
  validate-environment:
    name: ğŸ”’ Validate Environment & Secrets
    runs-on: ubuntu-latest
    outputs:
      deploy-url: ${{ steps.env-config.outputs.deploy-url }}
      health-endpoint: ${{ steps.env-config.outputs.health-endpoint }}
      requires-approval: ${{ steps.env-config.outputs.requires-approval }}
      
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Configure environment settings
      id: env-config
      run: |
        case "${{ env.DEPLOY_ENV }}" in
          "development")
            echo "deploy-url=https://dev.xcloud-bot.local" >> $GITHUB_OUTPUT
            echo "health-endpoint=https://dev.xcloud-bot.local/health" >> $GITHUB_OUTPUT
            echo "requires-approval=false" >> $GITHUB_OUTPUT
            ;;
          "staging")
            echo "deploy-url=https://staging.xcloud-bot.example.com" >> $GITHUB_OUTPUT
            echo "health-endpoint=https://staging.xcloud-bot.example.com/health" >> $GITHUB_OUTPUT
            echo "requires-approval=false" >> $GITHUB_OUTPUT
            ;;
          "production")
            echo "deploy-url=https://xcloud-bot.example.com" >> $GITHUB_OUTPUT
            echo "health-endpoint=https://xcloud-bot.example.com/health" >> $GITHUB_OUTPUT
            echo "requires-approval=true" >> $GITHUB_OUTPUT
            ;;
          *)
            echo "âŒ Invalid environment: ${{ env.DEPLOY_ENV }}"
            exit 1
            ;;
        esac
        
    - name: ğŸ” Validate secrets
      run: |
        echo "ğŸ” Validating environment-specific secrets for ${{ env.DEPLOY_ENV }}..."
        # Add secret validation logic here
        echo "âœ… Secrets validation completed"

  pre-deployment-checks:
    name: ğŸ§ª Pre-deployment Checks
    runs-on: ubuntu-latest
    needs: validate-environment
    if: ${{ !inputs.force_deploy }}
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ—ï¸ Build application
      run: npm run build
      
    - name: ğŸ§ª Run tests
      run: npm test
      
    - name: ğŸ” Security checks
      run: npm audit --audit-level=moderate
      
    - name: ğŸ“Š Generate deployment report
      run: |
        echo "ğŸ“Š Deployment Report for ${{ env.DEPLOY_ENV }}" > deployment-report.md
        echo "- Environment: ${{ env.DEPLOY_ENV }}" >> deployment-report.md
        echo "- Strategy: ${{ env.DEPLOYMENT_STRATEGY }}" >> deployment-report.md
        echo "- Timestamp: $(date -u)" >> deployment-report.md
        echo "- Commit: ${{ github.sha }}" >> deployment-report.md
        
    - name: ğŸ“¤ Upload deployment artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deployment-artifacts-${{ env.DEPLOY_ENV }}
        path: |
          dist/
          deployment-report.md
        retention-days: 30

  production-approval:
    name: ğŸ›¡ï¸ Production Approval Gate
    runs-on: ubuntu-latest
    needs: [validate-environment, pre-deployment-checks]
    if: ${{ needs.validate-environment.outputs.requires-approval == 'true' }}
    environment: 
      name: production
      url: ${{ needs.validate-environment.outputs.deploy-url }}
    
    steps:
    - name: ğŸš€ Production deployment approved
      run: echo "âœ… Production deployment has been approved"

  deploy:
    name: ğŸš€ Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: [validate-environment, pre-deployment-checks]
    if: always() && (needs.pre-deployment-checks.result == 'success' || inputs.force_deploy) && (needs.production-approval.result == 'success' || needs.validate-environment.outputs.requires-approval == 'false')
    
    environment:
      name: ${{ inputs.environment }}
      url: ${{ needs.validate-environment.outputs.deploy-url }}
    
    outputs:
      url: ${{ needs.validate-environment.outputs.deploy-url }}
      version: ${{ steps.deployment-info.outputs.version }}
      strategy: ${{ env.DEPLOYMENT_STRATEGY }}
      
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download deployment artifacts
      uses: actions/download-artifact@v4
      with:
        name: deployment-artifacts-${{ env.DEPLOY_ENV }}
        path: ./
        
    - name: ğŸš€ Execute deployment strategy
      id: deploy-execution
      run: |
        echo "ğŸš€ Starting ${{ env.DEPLOYMENT_STRATEGY }} deployment to ${{ env.DEPLOY_ENV }}..."
        
        case "${{ env.DEPLOYMENT_STRATEGY }}" in
          "rolling")
            echo "ğŸ”„ Executing rolling deployment..."
            # Rolling deployment logic
            ;;
          "blue-green")
            echo "ğŸ”µğŸŸ¢ Executing blue-green deployment..."
            # Blue-green deployment logic
            ;;
          "canary")
            echo "ğŸ¤ Executing canary deployment..."
            # Canary deployment logic
            ;;
        esac
        
        # Simulate deployment process
        sleep 10
        echo "âœ… Deployment completed successfully"
        
    - name: ğŸ“Š Deployment info
      id: deployment-info
      run: |
        VERSION="1.0.0-${{ github.run_number }}"
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "ğŸ“Š Deployed version: ${VERSION}"
        echo "ğŸŒ Environment: ${{ env.DEPLOY_ENV }}"
        echo "ğŸ“ˆ Strategy: ${{ env.DEPLOYMENT_STRATEGY }}"

  health-checks:
    name: ğŸ¥ Health Checks
    runs-on: ubuntu-latest
    needs: [validate-environment, deploy]
    if: always() && needs.deploy.result == 'success'
    
    steps:
    - name: ğŸ” Application startup check
      run: |
        echo "ğŸ” Checking application startup..."
        # Simulate health check
        sleep 5
        echo "âœ… Application started successfully"
        
    - name: ğŸ—„ï¸ Database connection check
      run: |
        echo "ğŸ—„ï¸ Checking database connections..."
        # Simulate database check
        sleep 3
        echo "âœ… Database connections healthy"
        
    - name: ğŸŒ External API checks
      run: |
        echo "ğŸŒ Checking external API connectivity..."
        # Simulate API checks
        sleep 3
        echo "âœ… External APIs responding"
        
    - name: ğŸ“Š Performance metrics check
      run: |
        echo "ğŸ“Š Checking performance metrics..."
        # Simulate performance check
        sleep 3
        echo "âœ… Performance metrics within bounds"
        
    - name: ğŸš¨ Error rate monitoring
      run: |
        echo "ğŸš¨ Monitoring error rates..."
        # Simulate error monitoring
        sleep 3
        echo "âœ… Error rates below threshold"
        
    - name: ğŸ¥ Comprehensive health check
      run: |
        HEALTH_URL="${{ needs.validate-environment.outputs.health-endpoint }}"
        echo "ğŸ¥ Running comprehensive health check against: ${HEALTH_URL}"
        
        # Simulate health endpoint check
        # In real scenario: curl -f "${HEALTH_URL}" || exit 1
        echo "âœ… All health checks passed"

  post-deployment-monitoring:
    name: ğŸ“Š Post-deployment Monitoring
    runs-on: ubuntu-latest
    needs: [validate-environment, deploy, health-checks]
    if: always() && needs.deploy.result == 'success' && needs.health-checks.result == 'success'
    
    steps:
    - name: ğŸ“Š Start monitoring
      run: |
        echo "ğŸ“Š Starting post-deployment monitoring for ${{ env.DEPLOY_ENV }}..."
        echo "ğŸ” Monitoring deployment: ${{ needs.deploy.outputs.version }}"
        echo "ğŸŒ Environment URL: ${{ needs.deploy.outputs.url }}"
        
    - name: ğŸ“ˆ Collect deployment metrics
      run: |
        echo "ğŸ“ˆ Collecting deployment metrics..."
        echo "- Deployment time: $(date -u)"
        echo "- Strategy used: ${{ needs.deploy.outputs.strategy }}"
        echo "- Environment: ${{ env.DEPLOY_ENV }}"
        echo "- Version: ${{ needs.deploy.outputs.version }}"
        
    - name: ğŸ”” Send notifications
      run: |
        echo "ğŸ”” Sending deployment notifications..."
        echo "âœ… Deployment to ${{ env.DEPLOY_ENV }} completed successfully!"
        echo "ğŸŒ URL: ${{ needs.deploy.outputs.url }}"
        echo "ğŸ“¦ Version: ${{ needs.deploy.outputs.version }}"

  rollback:
    name: ğŸ”„ Rollback on Failure
    runs-on: ubuntu-latest
    needs: [validate-environment, deploy, health-checks]
    if: always() && (needs.deploy.result == 'failure' || needs.health-checks.result == 'failure')
    
    steps:
    - name: ğŸš¨ Deployment failure detected
      run: |
        echo "ğŸš¨ Deployment failure detected for ${{ env.DEPLOY_ENV }}"
        echo "Deploy status: ${{ needs.deploy.result }}"
        echo "Health check status: ${{ needs.health-checks.result }}"
        
    - name: ğŸ”„ Execute rollback
      run: |
        echo "ğŸ”„ Initiating rollback for ${{ env.DEPLOY_ENV }}..."
        # Rollback logic would go here
        sleep 5
        echo "âœ… Rollback completed successfully"
        
    - name: ğŸ”” Rollback notification
      run: |
        echo "ğŸ”” Sending rollback notifications..."
        echo "ğŸš¨ Deployment to ${{ env.DEPLOY_ENV }} failed and was rolled back"
        echo "ğŸŒ Environment: ${{ needs.validate-environment.outputs.deploy-url }}"