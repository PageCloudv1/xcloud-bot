name: 'ü§ñ Auto Copilot Review'

on:
  issues:
    types: [opened, edited]
  pull_request:
    types: [opened, synchronize, edited]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue/PR number to review'
        required: false
        type: string

concurrency:
  group: '${{ github.workflow }}-${{ github.event_name }}-${{ github.event.pull_request.number || github.event.issue.number || inputs.issue_number }}'
  cancel-in-progress: true

defaults:
  run:
    shell: 'bash'

jobs:
  auto-review:
    runs-on: 'ubuntu-latest'
    timeout-minutes: 5
    permissions:
      contents: 'read'
      issues: 'write'
      pull-requests: 'write'
    
    steps:
      - name: 'Checkout repository'
        uses: 'actions/checkout@v4'

      - name: 'Auto-assign Copilot for review'
        uses: 'actions/github-script@v7'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { context } = require('@actions/github');
            
            // Determinar se √© issue ou PR
            const isIssue = context.eventName === 'issues' || context.payload.issue;
            const isPR = context.eventName === 'pull_request' || context.payload.pull_request;
            const number = context.payload.pull_request?.number || context.payload.issue?.number || context.payload.inputs?.issue_number;
            
            if (!number) {
              console.log('Nenhum n√∫mero de issue/PR encontrado');
              return;
            }

            // Coment√°rio padr√£o solicitando review do Copilot
            const reviewComment = `ü§ñ **Auto Review Request**

@Copilot, por favor, revise ${isIssue ? 'esta issue' : 'este pull request'} considerando:

${isPR ? `
- **Qualidade do c√≥digo**: Verificar boas pr√°ticas, padr√µes e poss√≠veis bugs
- **Seguran√ßa**: Identificar vulnerabilidades potenciais
- **Performance**: Sugerir otimiza√ß√µes quando necess√°rio
- **Testes**: Avaliar cobertura e qualidade dos testes
- **Documenta√ß√£o**: Verificar se a documenta√ß√£o est√° adequada
` : `
- **Clareza**: A descri√ß√£o est√° clara e completa?
- **Prioridade**: Qual a urg√™ncia desta tarefa?
- **Escopo**: O escopo est√° bem definido?
- **Depend√™ncias**: Existem depend√™ncias que devem ser consideradas?
- **Estimativa**: Qual a complexidade estimada?
`}

**Contexto adicional**: Esta √© uma solicita√ß√£o autom√°tica de review para garantir qualidade e consist√™ncia em nossos ${isIssue ? 'issues' : 'pull requests'}.

---
*Gerado automaticamente pelo xcloud-bot workflow*`;

            try {
              if (isPR) {
                // Para PRs, criar um review request
                await github.rest.pulls.requestReviewers({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: number,
                  reviewers: [], // Copilot n√£o pode ser adicionado como reviewer tradicional
                });
                
                // Adicionar coment√°rio no PR
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: number,
                  body: reviewComment
                });
                
                console.log(`‚úÖ Review autom√°tico solicitado para PR #${number}`);
              } else {
                // Para issues, apenas comentar
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: number,
                  body: reviewComment
                });
                
                console.log(`‚úÖ Review autom√°tico solicitado para Issue #${number}`);
              }
            } catch (error) {
              console.error('Erro ao solicitar review:', error);
              core.setFailed(`Falha ao solicitar review: ${error.message}`);
            }

      - name: 'Trigger Gemini Review (if PR)'
        if: github.event_name == 'pull_request'
        uses: ./.github/workflows/gemini-review.yml@main
        with:
          additional_context: 'Review autom√°tico solicitado via workflow auto-copilot-review'