name: ðŸŽ¯ Main Workflow

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      run_tests:
        description: 'Run tests'
        required: false
        default: true
        type: boolean
      run_build:
        description: 'Run build'
        required: false
        default: true
        type: boolean
      run_deploy:
        description: 'Run deploy'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  
jobs:
  setup:
    name: ðŸ”§ Setup
    runs-on: ubuntu-latest
    
    outputs:
      run-tests: ${{ steps.config.outputs.run-tests }}
      run-build: ${{ steps.config.outputs.run-build }}
      run-deploy: ${{ steps.config.outputs.run-deploy }}
      
    steps:
    - name: ðŸ“‹ Configure workflow
      id: config
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "run-tests=${{ github.event.inputs.run_tests }}" >> $GITHUB_OUTPUT
          echo "run-build=${{ github.event.inputs.run_build }}" >> $GITHUB_OUTPUT
          echo "run-deploy=${{ github.event.inputs.run_deploy }}" >> $GITHUB_OUTPUT
        else
          echo "run-tests=true" >> $GITHUB_OUTPUT
          echo "run-build=true" >> $GITHUB_OUTPUT
          echo "run-deploy=false" >> $GITHUB_OUTPUT
        fi
        
  call-ci:
    name: ðŸ”„ Call CI Workflow
    needs: setup
    if: needs.setup.outputs.run-tests == 'true' || needs.setup.outputs.run-build == 'true'
    uses: ./.github/workflows/ci.yml
    
  call-test:
    name: ðŸ§ª Call Test Workflow
    needs: setup
    if: needs.setup.outputs.run-tests == 'true'
    uses: ./.github/workflows/test.yml
    
  call-build:
    name: ðŸ—ï¸ Call Build Workflow
    needs: setup
    if: needs.setup.outputs.run-build == 'true'
    uses: ./.github/workflows/build.yml
    
  call-deploy:
    name: ðŸš€ Call Deploy Workflow
    needs: [call-ci, call-test, call-build]
    if: needs.setup.outputs.run-deploy == 'true' && success()
    uses: ./.github/workflows/deploy.yml
    
  health-check:
    name: ðŸ¥ Health Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ¥ Run health checks
      run: |
        echo "ðŸ” Running daily health checks..."
        echo "ðŸ“Š Repository status: OK"
        echo "ðŸ”§ Dependencies check: OK"
        echo "ðŸ›¡ï¸ Security scan: OK"
        
  summary:
    name: ðŸ“Š Workflow Summary
    runs-on: ubuntu-latest
    needs: [call-ci, call-test, call-build, call-deploy, health-check]
    if: always()
    
    steps:
    - name: ðŸ“Š Generate summary
      run: |
        echo "## ðŸŽ¯ Main Workflow Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| CI | ${{ needs.call-ci.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Test | ${{ needs.call-test.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build | ${{ needs.call-build.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Deploy | ${{ needs.call-deploy.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Health Check | ${{ needs.health-check.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY